name: Deploy to Server (Git Pull)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - 'README.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Server Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST43 }}
          username: ${{ secrets.USER43 }}
          password: ${{ secrets.PASSWORD43 }}
          script_stop: true
          script: |
            echo "1. Preparing environment..."
            # 确保目录存在
            mkdir -p ~/manjing-ai-go
            cd ~/manjing-ai-go
            
            # 如果是第一次，需要 clone，否则 pull
            if [ ! -d ".git" ]; then
                echo "Cloning repository..."
                git clone https://github.com/manjing-ai/manjing-ai-go.git .
            fi
            
            echo "2. Pulling latest code (with retry)..."
            # 重试逻辑：尝试 5 次，每次间隔 2 秒
            count=0
            retries=5
            until git pull origin main; do
                exit_code=$?
                count=$((count + 1))
                if [ $count -lt $retries ]; then
                    echo "Pull failed. Retrying $count/$retries in 2s..."
                    sleep 2
                else
                    echo "Git pull failed after $retries attempts."
                    exit $exit_code
                fi
            done
            
            echo "3. Building Binary..."
            # 使用服务器上的 Go
            export PATH=$PATH:/usr/local/go/bin
            go version
            
            # 编译
            go mod tidy
            CGO_ENABLED=0 go build -ldflags="-s -w" -o manjing-ai-go ./cmd/api
            
            echo "4. Restarting Service..."
            export PATH=$PATH:/root/.nvm/versions/node/v22.22.0/bin
            
            pm2 delete manjing-go || true
            pm2 start ./manjing-ai-go --name "manjing-go" -- -config config.dev.yaml
            pm2 save
            
            echo "Deploy Success"
